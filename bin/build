#!/usr/bin/env bash

set -e

. bin/build_utils

# Supports two different tags to represent a tagged build (./bin/build) and dev build
# (env GOOS=darwin GOARCH=amd64 go build) of project binaries
TAG="$(git rev-parse --short HEAD)"
FULL_TAG="conjur-authn-k8s-client:$(version_tag)"

VERSION="$(short_version_tag)"

function finish {
    rm -f authenticator
}
trap finish EXIT

echo "---"

echo "Building conjur-authn-k8s-client-go with tag ${TAG} <<"

docker build -t conjur-authn-k8s-client-go:builder .

docker run --rm \
           -v $PWD:/opt/conjur-authn-k8s-client \
           conjur-authn-k8s-client-go:builder env CGO_ENABLED=0 GOOS=linux \
              go build -a -installsuffix cgo \
               -ldflags="-X github.com/cyberark/conjur-authn-k8s-client/pkg/authenticator.Tag=$TAG" \
              -o authenticator ./cmd/authenticator

# bin/build conjur-authn-k8s-client:dev
# run image with newly build conjur-authn-k8s-client/ would appear in logs

docker build -f Dockerfile.scratch \
             -t "${FULL_TAG}" \
             .

docker build --build-arg VERSION="$VERSION" \
             -f Dockerfile.redhat \
             -t "${FULL_TAG}-redhat" \
             .

echo "---"
